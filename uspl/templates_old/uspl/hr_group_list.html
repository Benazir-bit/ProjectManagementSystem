{% extends "uspl/base.html" %}
{% block title %}Group List{% endblock %}

{% block content %}
<div id="base-main-body" class="col-sm-8">
  <div class="row">
		<div class="col-sm-12">
			<br>
			<div id="main-body-div">
				<div id="main_body_header" class="row">
					<p><b>Groups</b></p>
				</div>
				<div class="table-responsive">
					<table id="member_table" class="table table-hover">
						<thead>
							<tr>
								<th>Name</th>
								<th>Teamleader</th>
								<th>Total Members</th>
							</tr>
						</thead>
						<tbody>
							{% for group in groups %}
								<tr id="row_mem{{group.id}}">
									<td>
										<a href="{% url 'uspl:group_members' group.id %}">{{group.name}}</a>
									</td>
									<td>
										{% if group.teamleader %}
											{% for user in group.teamleader.employees.all %}
												<a id ="member_ref" href="{% url 'uspl:employee_profile' user.id %}">
													<img class="img-circle" id="member_pic" src="{{ user.profile.image.url }}" alt="{{ user.first_name }}" title="{{ user.get_full_name }}">
												</a>
											{% endfor %}
										{% else %}
											<button id = "edit_delete_btn" class="btn btn-info btn-sm" data-toggle="modal" data-target="#addTL{{group.id}}">
												<span class="glyphicon glyphicon-plus"></span> Add T.L.
        									</button>
        									<!--Add Team Leader Modal -->
											<div class="modal fade" id="addTL{{group.id}}" role="dialog">
												<div class="modal-dialog">
													<!-- Modal content-->
													<div class="modal-content">
														<div class="modal-header">
															<button type="button" class="close" data-dismiss="modal">&times;</button>
															<h3 class="modal-title"><b>Add Team Leader<b></h3>
														</div>
														<div class="modal-body">
															<form method="post" class = "form-set"> 
																{% csrf_token %}
																<table class="table table-striped">
																	<input type="hidden" name="group_id" value="{{group.id}}">
																	<tr>
																		<td colspan="1" id = "table-form">
																			<label for="new_name">Select Teamleader:</label>
																		</td>
																		<td>
																			{% if group.user_set.all.count > 0 %}
																				<select name="tl_selected" multiple required>
																					<option value="" disabled>Select Teamleader</option>
																					{% for user in group.user_set.all %}
																						<option value="{{user.id}}">{{user.get_full_name}} ({{user.username}})</option>
																					{% endfor %}
																				</select>
																			{% else %}
																				No User Found!
																			{% endif %}
																		</td>
																	</tr>
																</table>
																<div class="row" align="center">
																	{% if group.user_set.all.count > 0 %}
																	<button class="btn btn-primary" type="submit" role="button" name="addTL"><b>Update<b></button>
																	{% endif %}
																</div>
															</form>
														</div>
														<div class="modal-footer">
															<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
														</div>
													</div>
												</div>
											</div>
										{% endif %}
									</td>
									<td>
										{{group.user_set.all.count}}
									</td>
									<td>
										<button id = "edit_delete_btn" class="btn btn-info btn-sm" data-toggle="modal" data-target="#updateGroup{{group.id}}">
											<span class="glyphicon glyphicon-edit"></span> Edit
        								</button>
										<a class="btn btn-danger btn-sm" id = "edit_delete_btn" href="{% url 'uspl:delete_group' group.id %}">
          									<span class="glyphicon glyphicon-trash"></span> Delete 
        								</a>
        								<!--Update Group Modal -->
										<div class="modal fade" id="updateGroup{{group.id}}" role="dialog">
											<div class="modal-dialog">
												<!-- Modal content-->
												<div class="modal-content">
													<div class="modal-header">
														<button type="button" class="close" data-dismiss="modal">&times;</button>
														<h3 class="modal-title"><b>Update Group<b></h3>
													</div>
													<div class="modal-body">
														<form method="post" class = "form-set"> 
															{% csrf_token %}
															<table class="table table-striped">
																<input type="hidden" name="group_id" value="{{group.id}}">
																<tr>
																	<td colspan="1" id = "table-form">
																		<label for="new_name">Group Name:</label>
																	</td>
																	<td>
																		<input type="text" name="new_name" class="form-control" value="{{group.name}}">
																	</td>
																</tr>
																<tr>
																	<td colspan="1" id = "table-form">
																		<label for="new_name">Select Teamleader:</label>
																	</td>
																	<td>
																		{% if group.user_set.all.count > 0 %}
																			<select name="user_selected" multiple required style="width:100%">
																				<option value="" disabled>Select Teamleader</option>
																				{% for user in group.user_set.all %}
																					<option value="{{user.id}}"  {% if user in group.teamleader.employees.all %}selected{% endif %}>{{user.get_full_name}} ({{user.username}})</option>
																				{% endfor %}
																			</select>
																		{% else %}
																			No User Found!
																		{% endif %}
																	</td>
																</tr>
															</table>
															<div class="row" align="center">
																<button class="btn btn-primary" type="submit" role="button" name="update_group"><b>Update<b></button>
															</div>
														</form>
													</div>
													<div class="modal-footer">
														<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
													</div>
												</div>
											</div>
										</div>
									</td>
								</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
				<br>
				<br>
				<center>
					<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addGroup"><span class="glyphicon glyphicon-plus"></span>Add New Group</button>
				</center>
			</div>	
		</div>
	</div>
</div>	

<!--Add Group Modal -->
<div class="modal fade" id="addGroup" role="dialog">
	<div class="modal-dialog">
		<!-- Modal content-->
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal">&times;</button>
				<h3 class="modal-title"><b>Add New Group<b></h3>
			</div>
			<div class="modal-body">
				<form method="post" class = "form-set"> 
					{% csrf_token %}
					<table class="table table-striped">
						<tr>
							<td colspan="1" id = "table-form">
								<label for="name">Group Name:</label>
							</td>
							<td>
								<input type="text" name="name" class="form-control" placeholder="Enter Group Name" required>
							</td>
						</tr>
					</table>
					<div class="row" align="center">
						<button class="btn btn-primary" type="submit" role="button" name="add_group"><b>Create<b></button>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
			</div>
		</div>
	</div>
</div>
{% endblock %}
{% block news %}
{% if not request.user.profile.is_hr %}
<!-- News -->
<div class="col-sm-2">
	<div class="fixed col-xs-2 sidebar-outer" id="news_col">
		<p id="news_header"><b>Recent Activities</b></p><br>
		<div class="scrollbar">
			{% for news in newses %}
				<div class="row event">
					<div class="col-xs-2 col-md-4 col-lg-3" id="news-pic">
						<a href="{% url 'uspl:employee_profile' news.owner.id %}"><img class="img-circle" id="news_pic" src="{{news.owner.profile.image.url}}"></a>
					</div>
					<div class="col-xs-9 col-md-8 col-lg-9" id="news_msg">
						<p><strong><b><a href="{% url 'uspl:employee_profile' news.owner.id %}">{{news.owner.get_full_name}}</a></b></strong> {{news.message}}<br></p>
						<p><span class="glyphicon glyphicon-time"></span> {{news.created_date}}</p>
					</div>
				</div>
				<hr>
			{% endfor %}
			</div>
				<p id="news_header"><b><a href="{% url 'uspl:news_list' 1 %}">View All</a></b></p>
			</div>
		</div>
	</div>
</div>
{% endif %}
{% endblock %}

{% block external_js %}
<script>
function remove_selected_item(elem, e) {
    e.stopPropagation();
    var option_text = elem.parentElement.querySelector(".select7_content").innerHTML;
    var option_value = elem.parentElement.querySelector(".select7_content").dataset.optionValue;
    var selector = elem.parentElement.parentElement.parentElement.querySelector(".select7_select");
    
    // selector.innerHTML += `<option value="${ option_value }">${ option_text }</option>`;
    selector.innerHTML += "<option value='"+ option_value +"'>"+ option_text +"</option>";
    
    if (selector.length > 1)
        selector.style.display = "block";
    
    var selected_items = elem.parentElement.parentElement.parentElement.querySelectorAll(".select7_item");
    if (selected_items.length == 1) {
        var placeholder = elem.parentElement.parentElement.parentElement.querySelector(".select7_placeholder");
        placeholder.style.display = "block";
    }

    // elem.parentElement.remove();
    elem.parentElement.parentElement.removeChild(elem.parentElement);
}

function add_selected_item(elem, e) {
    e.stopPropagation();
    var option_text =  elem[elem.selectedIndex].text;
    var option_value =  elem[elem.selectedIndex].value;
    var selected_items = elem.parentElement.querySelector(".select7_items");
    var placeholder = elem.parentElement.querySelector(".select7_placeholder");
    if (option_value === "filler" && option_text === "")
        return;

    placeholder.style.display = "none";
    // selected_items.innerHTML += `
    //     <div class="select7_item">
    //         <div data-option-value="${option_value}" class="select7_content">${option_text}</div>
    //         <div class="select7_del" onclick="remove_selected_item(this, event);">&#10006;</div>
    //     </div>`;

    selected_items.innerHTML += "<div class='select7_item'><div data-option-value='"+ option_value +"' class='select7_content'>"+ option_text +"</div><div class='select7_del' onclick='remove_selected_item(this, event);'><div class='select7_x'></div><div class='select7_x'></div></div></div> ";

    // elem[elem.selectedIndex].remove();
    elem[elem.selectedIndex].parentElement.removeChild(elem[elem.selectedIndex]);
    if (elem.length == 1)
        elem.style.display = "none";
}

function get_selected_items(select7_id, type/* = "both"*/) {
    type = type || "both";
    var selected_items = document.getElementById(select7_id).querySelectorAll(".select7_content");

    if (selected_items.length > 0) {
        var selected_values = [];
        
        if (type == "value")
            for (let i = 0; i < selected_items.length; i++)
                selected_values.push(selected_items[i].dataset.optionValue);
        
                if (type == "text")
            for (let i = 0; i < selected_items.length; i++)
                selected_values.push(selected_items[i].innerHTML);
        
        if (type == "both")
            for (let i = 0; i < selected_items.length; i++)
                selected_values.push({
                    "text": selected_items[i].innerHTML,
                    "value": selected_items[i].dataset.optionValue,
                });

        return selected_values;
    }

    return null;
}

</script>
{% endblock %}